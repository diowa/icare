##############################################################
# 
<%= include_passenger_internal_template('global.erb') %>

worker_processes <%= ENV['PASSENGER_WORKER_PROCESSES'] || 2 %>;
events {
    worker_connections <%= ENV['PASSENGER_WORKER_CONNECTIONS'] || 1024 %>;
}

http {
    <%= include_passenger_internal_template('http.erb', 4) %>

    default_type application/octet-stream;
    types_hash_max_size 2048;
    server_names_hash_bucket_size 64;
    client_max_body_size 1024m;
    access_log off;
    keepalive_timeout <%= ENV['PASSENGER_KEEPALIVE_TIMEOUT'] || 60 %>;
    underscores_in_headers on;
    gzip on;
    gzip_comp_level 3;
    gzip_min_length 150;
    gzip_proxied any;
    passenger_friendly_error_pages off;
    passenger_show_version_in_header off;
    passenger_max_pool_size <%= ENV.fetch('PASSENGER_MAX_POOL_SIZE', '2') %>;
    passenger_min_instances <%= ENV.fetch('PASSENGER_MIN_INSTANCES', '1') %>;
    gzip_types text/plain text/css text/json text/javascript
        application/javascript application/x-javascript application/json
        application/rss+xml application/vnd.ms-fontobject application/x-font-ttf
        application/xml font/opentype image/svg+xml text/xml;

    <% if @app_finder.multi_mode? %>
        # Default server entry for mass deployment mode.
        server {
            <%= include_passenger_internal_template('mass_deployment_default_server.erb', 12) %>
        }
    <% end %>

    <% for app in @apps %>
    server {
        <%= include_passenger_internal_template('server.erb', 8, true, binding) %>
        <%= include_passenger_internal_template('rails_asset_pipeline.erb', 8, false) %>

    }
    server {
      listen 443 ssl;
      server_name localhost;

      passenger_enabled on;
      rails_env development;
      root /app/public;

      ssl on;
      ssl_certificate /app/docker/development.crt;
      ssl_certificate_key /app/docker/development.key;

      ssl_session_timeout  5m;

      ssl_protocols  SSLv2 SSLv3 TLSv1;
      ssl_ciphers  HIGH:!aNULL:!MD5;
      ssl_prefer_server_ciphers   on;

      location ^~ /assets/ {
        gzip_static on;
        expires max;
        add_header Cache-Control public;
      }

      error_page 500 502 503 504 /500.html;
      client_max_body_size 4G;
      keepalive_timeout 10;
    }
    passenger_pre_start <%= listen_url(app) %>;
    passenger_pool_idle_time 0;
    <% end %>
    <%= include_passenger_internal_template('footer.erb', 4) %>
}
